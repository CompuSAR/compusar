#!/usr/bin/python3

import argparse
import pathlib
import png

parser = argparse.ArgumentParser(
                    prog='png2source',
                    description='Convert a PNG image to C++ source of a compusar bitmap')

parser.add_argument('png_file', help='Source binary file')
parser.add_argument('out_file', help='Output assembly file')
parser.add_argument('--name', type=str, help='Use a symbol name other than the png file name')

args = parser.parse_args()

image = png.Reader(args.png_file)
width, height, data, attributes = image.asRGBA8()


name = pathlib.Path(args.png_file).stem
if args.name:
    name = args.name

cpppath = pathlib.Path(args.out_file)

with open(args.out_file, "w") as outfile:
    print(
f"""// This file was automatically generated by png2source. Do not manually edit, or your changes may be unceremoniously
// relegated to the great bit bucket in the sky known to all as "regret"

#include "{cpppath.with_suffix(".h").name}"

namespace Bitmaps {{

const Display::Bitmap {name} {{
    .width = {width}, .height = {height},
    .data = {{""", file=outfile)

    for row in data:
        print("        ", file=outfile, end='')
        while row:
            if row[3] < 0x40:
                print("0x84, ", file=outfile, end='')
            else:
                byte = 0
                if row[3] < 0xc0:
                    byte |= 0x80

                byte |= (row[0]>>6) << 5    # Red
                byte |= (row[1]>>5) << 2    # Green
                byte |= (row[2]>>6)         # Blue

                print("0x{0:02x}, ".format(byte), file=outfile, end='')

            row = row[4:]
        print("", file=outfile)

    print(
f"""    }}
}};

}} // namespace Bitmaps""", file=outfile)

with open( pathlib.Path(args.out_file).with_suffix(".h"), "w" ) as outfile:
    print(
f"""// This file was automatically generated by png2source. Do not manually edit, or your changes may be unceremoniously
// relegated to the great bit bucket in the sky known to all as "regret"

#pragma once

#include <bitmap.h>

namespace Bitmaps {{

    extern const Display::Bitmap {name};

}} // namespace Bitmaps""", file=outfile)

